---
config:
  layout: elk
  elk:
    mergeEdges: true
    nodePlacementStrategy: NETWORK_SIMPLEX
    cycleBreakingStrategy: GREEDY
  c4:
    diagramMarginX: 25
    diagramMarginY: 25
---
C4Component
    title Event Driven - Circuit Breaker - Component View [Azure / Go / gRPC]

    Container(api_layer, "Event Driven API", "gRPC + REST Gateway", "Camada de API do dominio", $sprite="img:https://icon.icepanel.io/Azure/svg/Integration/API-Management-Services.svg")
    ContainerDb(main_db, "Database", "Azure SQL Database", "Banco de dados principal", $sprite="img:https://icon.icepanel.io/Azure/svg/Databases/SQL-Database.svg")
    ContainerQueue(msg_queue, "Message Queue", "Service Bus Queue", "Fila de mensagens", $sprite="img:https://icon.icepanel.io/Azure/svg/Integration/Service-Bus.svg")
    ContainerDb(pattern_store, "Pattern Store", "Cosmos DB", "Estado do padrao", $sprite="img:https://icon.icepanel.io/Azure/svg/Databases/Azure-Cosmos-DB.svg")

    Container_Boundary(comp0, "Event Driven Circuit Breaker") {
        Component(Circuit_Manager, "Circuit Manager", "Gin", "Responsavel por circuit manager", $sprite="img:https://icon.icepanel.io/Azure/svg/Compute/App-Services.svg")
        Component(Fallback_Handler, "Fallback Handler", "Gin", "Responsavel por fallback handler", $sprite="img:https://icon.icepanel.io/Azure/svg/Compute/App-Services.svg")
        Component(Health_Checker, "Health Checker", "Gin", "Responsavel por health checker", $sprite="img:https://icon.icepanel.io/Azure/svg/Compute/App-Services.svg")
        Component(Metrics_Recorder, "Metrics Recorder", "sqlx + pgx", "Responsavel por metrics recorder", $sprite="img:https://icon.icepanel.io/Azure/svg/Compute/App-Services.svg")
        Component(ory_identity_handler, "Identity Handler", "Ory Kratos Client", "Gerencia authentication, session e MFA", $sprite="img:https://icon.icepanel.io/Azure/svg/Identity/Entra-ID.svg")
        Component(ory_permission_checker, "Permission Checker", "Ory Keto Client", "Check/Expand API para RBAC/ABAC via Zanzibar", $sprite="img:https://icon.icepanel.io/Azure/svg/Security/Key-Vaults.svg")
        Component(opa_policy_evaluator, "OPA Policy Evaluator", "OPA REST Client", "Avalia Rego policies para authorization e compliance", $sprite="img:https://icon.icepanel.io/Azure/svg/Networking/Front-Doors.svg")
        Component(dd_tracer, "DD Tracer", "dd-trace-go", "Instrumentacao automatica de spans para HTTP, gRPC, DB, Queue", $sprite="img:https://icon.icepanel.io/Azure/svg/Management-Governance/Monitor.svg")
        Component(dd_metrics_client, "Metrics Client", "DogStatsD Client", "Emite custom metrics: counters, gauges, histograms, distributions", $sprite="img:https://icon.icepanel.io/Azure/svg/Management-Governance/Monitor.svg")
        Component(dd_log_enricher, "Log Enricher", "Datadog Log Correlation", "Injeta trace_id e span_id nos logs para correlacao APM-Logs", $sprite="img:https://icon.icepanel.io/Azure/svg/Management-Governance/Monitor.svg")
    }

    Rel(api_layer, ory_identity_handler, "Valida identity/session", "Internal")
    Rel(ory_identity_handler, Circuit_Manager, "Autoriza e delega", "Internal")
    Rel(Circuit_Manager, ory_permission_checker, "Verifica permissao", "Internal")
    Rel(Circuit_Manager, opa_policy_evaluator, "Avalia policy de negocio", "Internal")
    Rel(Circuit_Manager, Fallback_Handler, "Delega para", "Internal")
    Rel(Fallback_Handler, Health_Checker, "Delega para", "Internal")
    Rel(Health_Checker, Metrics_Recorder, "Delega para", "Internal")
    Rel(Metrics_Recorder, main_db, "LÃª/Escreve", "Azure SQL Database")
    Rel(Circuit_Manager, pattern_store, "Persiste estado", "Cosmos DB")
    Rel(Metrics_Recorder, msg_queue, "Emite eventos", "Service Bus Queue")
    Rel(Circuit_Manager, dd_tracer, "Cria spans", "Internal")
    Rel(Metrics_Recorder, dd_metrics_client, "Emite metricas", "DogStatsD")
    Rel(Circuit_Manager, dd_log_enricher, "Enriquece logs com trace context", "Internal")

    UpdateElementStyle(Circuit_Manager, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(Fallback_Handler, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(Health_Checker, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(Metrics_Recorder, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(ory_identity_handler, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(ory_permission_checker, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(opa_policy_evaluator, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(dd_tracer, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(dd_metrics_client, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateElementStyle(dd_log_enricher, $fontColor="#FFFFFF", $bgColor="#0078D4", $borderColor="#002050")
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")