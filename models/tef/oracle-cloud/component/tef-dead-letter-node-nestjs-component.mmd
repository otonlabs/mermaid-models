---
config:
  layout: elk
  elk:
    mergeEdges: true
    nodePlacementStrategy: NETWORK_SIMPLEX
    cycleBreakingStrategy: GREEDY
  c4:
    diagramMarginX: 25
    diagramMarginY: 25
---
C4Component
    title TEF - Dead Letter - Component View [Oracle Cloud / Node.js / NestJS]

    Container(api_layer, "TEF API", "NestJS REST", "Camada de API do dominio", $sprite="img:https://icon.icepanel.io/OCI/svg/Developer-Services/API-Gateway.svg")
    ContainerDb(main_db, "Database", "Autonomous Database", "Banco de dados principal", $sprite="img:https://icon.icepanel.io/OCI/svg/Oracle-Database/Autonomous-Database.svg")
    ContainerQueue(msg_queue, "Message Queue", "OCI Queue", "Fila de mensagens", $sprite="img:https://icon.icepanel.io/OCI/svg/Developer-Services/Queue.svg")

    Container_Boundary(comp0, "TEF Dead Letter") {
        Component(DLQ_Consumer, "DLQ Consumer", "Bull + NestJS Microservices", "Responsavel por dlq consumer", $sprite="img:https://icon.icepanel.io/OCI/svg/Developer-Services/Functions.svg")
        Component(Retry_Scheduler, "Retry Scheduler", "NestJS", "Responsavel por retry scheduler", $sprite="img:https://icon.icepanel.io/OCI/svg/Developer-Services/Container-Engine-for-Kubernetes.svg")
        Component(Poison_Detector, "Poison Detector", "NestJS", "Responsavel por poison detector", $sprite="img:https://icon.icepanel.io/OCI/svg/Developer-Services/Container-Engine-for-Kubernetes.svg")
        Component(Alert_Notifier, "Alert Notifier", "Bull + NestJS Microservices", "Responsavel por alert notifier", $sprite="img:https://icon.icepanel.io/OCI/svg/Developer-Services/Functions.svg")
        Component(ory_identity_handler, "Identity Handler", "Ory Kratos Client", "Gerencia authentication, session e MFA", $sprite="img:https://icon.icepanel.io/OCI/svg/Identity-Security/Identity-and-Access-Management.svg")
        Component(ory_permission_checker, "Permission Checker", "Ory Keto Client", "Check/Expand API para RBAC/ABAC via Zanzibar", $sprite="img:https://icon.icepanel.io/OCI/svg/Security/Vault.svg")
        Component(opa_policy_evaluator, "OPA Policy Evaluator", "OPA REST Client", "Avalia Rego policies para authorization e compliance", $sprite="img:https://icon.icepanel.io/OCI/svg/Security/Vault.svg")
        Component(dd_tracer, "DD Tracer", "dd-trace-js", "Instrumentacao automatica de spans para HTTP, gRPC, DB, Queue", $sprite="img:https://icon.icepanel.io/OCI/svg/Observability-Management/Monitoring.svg")
        Component(dd_metrics_client, "Metrics Client", "DogStatsD Client", "Emite custom metrics: counters, gauges, histograms, distributions", $sprite="img:https://icon.icepanel.io/OCI/svg/Observability-Management/Monitoring.svg")
        Component(dd_log_enricher, "Log Enricher", "Datadog Log Correlation", "Injeta trace_id e span_id nos logs para correlacao APM-Logs", $sprite="img:https://icon.icepanel.io/OCI/svg/Observability-Management/Monitoring.svg")
    }

    Rel(api_layer, ory_identity_handler, "Valida identity/session", "Internal")
    Rel(ory_identity_handler, DLQ_Consumer, "Autoriza e delega", "Internal")
    Rel(DLQ_Consumer, ory_permission_checker, "Verifica permissao", "Internal")
    Rel(DLQ_Consumer, opa_policy_evaluator, "Avalia policy de negocio", "Internal")
    Rel(DLQ_Consumer, Retry_Scheduler, "Delega para", "Internal")
    Rel(Retry_Scheduler, Poison_Detector, "Delega para", "Internal")
    Rel(Poison_Detector, Alert_Notifier, "Delega para", "Internal")
    Rel(Alert_Notifier, main_db, "LÃª/Escreve", "Autonomous Database")
    Rel(DLQ_Consumer, msg_queue, "Publica em", "OCI Queue")
    Rel(DLQ_Consumer, dd_tracer, "Cria spans", "Internal")
    Rel(Alert_Notifier, dd_metrics_client, "Emite metricas", "DogStatsD")
    Rel(DLQ_Consumer, dd_log_enricher, "Enriquece logs com trace context", "Internal")

    UpdateElementStyle(DLQ_Consumer, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(Retry_Scheduler, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(Poison_Detector, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(Alert_Notifier, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(ory_identity_handler, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(ory_permission_checker, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(opa_policy_evaluator, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(dd_tracer, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(dd_metrics_client, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateElementStyle(dd_log_enricher, $fontColor="#FFFFFF", $bgColor="#F80000", $borderColor="#C74634")
    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")